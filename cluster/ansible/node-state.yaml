---
# Idempotent node state management for k3s nodes.
# Safe to re-run at any time — converges to declared state.
#
# Usage:
#   All nodes:    ansible-playbook -i inventory.yaml --ask-vault-pass node-state.yaml
#   Single node:  ansible-playbook -i inventory.yaml --ask-vault-pass --limit cluster1 node-state.yaml
#   Dry-run:      ansible-playbook -i inventory.yaml --ask-vault-pass --check --diff node-state.yaml
#
# Override target group:  -e target=masters
# Override NTP servers:   -e '{"ntp_servers": ["192.168.1.1"]}'

- name: Enforce k3s node state
  hosts: "{{ target | default('all:!ubuntu') }}"
  become: true

  vars:
    ntp_servers:
      - ntp.ubuntu.com
      - 0.pool.ntp.org
      - 1.pool.ntp.org
    k3s_svc: "{{ 'k3s-agent' if cluster_role == 'agent' else 'k3s' }}"

  handlers:
    - name: Apply sysctl
      ansible.builtin.command: sysctl --system
      changed_when: false

    - name: Restart timesyncd
      ansible.builtin.systemd:
        name: systemd-timesyncd
        state: restarted
        enabled: true

    - name: Restart journald
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted

    - name: Restart multipathd
      ansible.builtin.systemd:
        name: multipathd
        state: restarted

  tasks:
    # ── Packages ────────────────────────────────────────────────────────────

    - name: Install base packages
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        lock_timeout: 300
        state: present
        pkg:
          - nfs-common
          - vim
          - unattended-upgrades
          - apt-listchanges

    - name: Install x86 media packages
      when: ansible_architecture == "x86_64"
      ansible.builtin.apt:
        state: present
        pkg:
          - intel-media-va-driver-non-free
          - libmfx1

    # ── Hostname ─────────────────────────────────────────────────────────────

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    # ── /etc/hosts ───────────────────────────────────────────────────────────

    - name: Template /etc/hosts
      ansible.builtin.template:
        src: templates/hosts.j2
        dest: /etc/hosts
        owner: root
        group: root
        mode: '0644'

    # ── NFS client ───────────────────────────────────────────────────────────

    - name: Template NFS global mount options (soft mounts)
      ansible.builtin.template:
        src: templates/nfsmount.conf.j2
        dest: /etc/nfsmount.conf
        owner: root
        group: root
        mode: '0644'

    # ── Kernel modules ───────────────────────────────────────────────────────

    - name: Ensure k3s kernel modules load on boot
      ansible.builtin.copy:
        content: |
          br_netfilter
          overlay
        dest: /etc/modules-load.d/k3s.conf
        owner: root
        group: root
        mode: '0644'

    - name: Load k3s kernel modules now
      ansible.builtin.command: "modprobe {{ item }}"
      loop:
        - br_netfilter
        - overlay
      changed_when: false

    # ── Kernel parameters ────────────────────────────────────────────────────

    - name: Template k3s sysctl parameters
      ansible.builtin.template:
        src: templates/sysctl-k3s.conf.j2
        dest: /etc/sysctl.d/99-k3s.conf
        owner: root
        group: root
        mode: '0644'
      notify: Apply sysctl

    # ── ARM: cgroup kernel command line ──────────────────────────────────────

    - name: ARM — ensure cgroup params in kernel cmdline
      when: ansible_architecture == "aarch64"
      ansible.builtin.lineinfile:
        path: /boot/firmware/cmdline.txt
        backrefs: true
        # Only append if not already present
        regexp: '^((?!.*cgroup_enable=memory).*)$'
        line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'

    # ── NTP ──────────────────────────────────────────────────────────────────

    - name: Template timesyncd NTP config
      ansible.builtin.template:
        src: templates/timesyncd.conf.j2
        dest: /etc/systemd/timesyncd.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart timesyncd

    # ── Security updates ─────────────────────────────────────────────────────

    - name: Template unattended-upgrades config
      ansible.builtin.template:
        src: templates/50unattended-upgrades.j2
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        owner: root
        group: root
        mode: '0644'

    - name: Enable automatic security updates
      ansible.builtin.copy:
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::AutocleanInterval "7";
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        owner: root
        group: root
        mode: '0644'

    # ── Swap ─────────────────────────────────────────────────────────────────

    - name: Disable swap immediately
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb | int > 0
      changed_when: ansible_swaptotal_mb | int > 0

    - name: Disable swap in fstab
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+\S+\s+.*)$'
        replace: '# \1'

    # ── Journald ─────────────────────────────────────────────────────────────

    - name: Configure journald volatile storage
      ansible.builtin.lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?Storage='
        line: 'Storage=volatile'
      notify: Restart journald

    # ── Multipath ────────────────────────────────────────────────────────────

    - name: Blacklist additional block devices in multipath
      ansible.builtin.blockinfile:
        path: /etc/multipath.conf
        create: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK - k3s"
        block: |
          blacklist {
            devnode "^sd[b-z0-9]+"
          }
      notify: Restart multipathd

    # ── k3s service ──────────────────────────────────────────────────────────
    # Flush config handlers first — sysctl, modules, etc. must be current
    # before we assess or restart k3s.

    - name: Flush config handlers before k3s health check
      ansible.builtin.meta: flush_handlers

    - name: Check k3s unit file exists
      ansible.builtin.stat:
        path: "/etc/systemd/system/{{ k3s_svc }}.service"
      register: k3s_unit

    - name: k3s not installed — skip
      when: not k3s_unit.stat.exists
      ansible.builtin.debug:
        msg: >
          {{ k3s_svc }} not installed on {{ inventory_hostname }}.
          Run k3s-agent.yaml first for initial installation.

    - name: Ensure k3s is enabled and started
      when: k3s_unit.stat.exists
      ansible.builtin.systemd:
        name: "{{ k3s_svc }}"
        state: started
        enabled: true
      failed_when: false

    - name: Get k3s ActiveState
      when: k3s_unit.stat.exists
      ansible.builtin.command: "systemctl show {{ k3s_svc }} --property=ActiveState --value"
      register: k3s_active_state
      changed_when: false
      failed_when: false

    - name: Get k3s restart count
      when: k3s_unit.stat.exists
      ansible.builtin.command: "systemctl show {{ k3s_svc }} --property=NRestarts --value"
      register: k3s_nrestarts
      changed_when: false
      failed_when: false

    # Unhealthy = not active, OR active but NRestarts > 5.
    # The second condition catches restart loops: the service is briefly "active"
    # between crashes, so is-active alone gives a false healthy signal.
    - name: Assess k3s health
      when: k3s_unit.stat.exists
      ansible.builtin.set_fact:
        k3s_healthy: >-
          {{ k3s_active_state.stdout | default('') == 'active'
             and k3s_nrestarts.stdout | default('99') | int <= 5 }}

    - name: k3s is healthy
      when: k3s_unit.stat.exists and k3s_healthy | default(false)
      ansible.builtin.debug:
        msg: >-
          {{ k3s_svc }} is active on {{ inventory_hostname }}
          (restarts: {{ k3s_nrestarts.stdout | default('?') }})

    - name: Diagnose and attempt fix for unhealthy k3s
      when: k3s_unit.stat.exists and not (k3s_healthy | default(false))
      block:
        - name: Get recent k3s journal
          ansible.builtin.command: "journalctl -u {{ k3s_svc }} --no-pager -n 50 -o short-iso"
          register: k3s_journal
          changed_when: false

        - name: Show diagnosis
          ansible.builtin.debug:
            msg: |
              !! {{ k3s_svc }} not healthy on {{ inventory_hostname }}
                 ActiveState: {{ k3s_active_state.stdout }}
                 Restarts:    {{ k3s_nrestarts.stdout }}

              Recent journal:
              {{ k3s_journal.stdout }}

        - name: Restart k3s with current config applied
          ansible.builtin.systemd:
            name: "{{ k3s_svc }}"
            state: restarted

        # NRestarts resets to 0 on explicit systemctl restart, then increments
        # for each auto-restart thereafter. Wait for 'active', then pause so
        # any restart loop has time to accumulate a non-zero count.
        - name: Wait for k3s to become active (up to 2 minutes)
          ansible.builtin.command: "systemctl show {{ k3s_svc }} --property=ActiveState --value"
          register: k3s_post_state
          until: k3s_post_state.stdout == 'active'
          retries: 12
          delay: 10
          changed_when: false
          failed_when: false

        - name: Pause 30 seconds to expose any restart loop
          when: k3s_post_state.stdout == 'active'
          ansible.builtin.pause:
            seconds: 30

        - name: Re-check ActiveState after stability window
          ansible.builtin.command: "systemctl show {{ k3s_svc }} --property=ActiveState --value"
          register: k3s_final_state
          changed_when: false

        - name: Re-check NRestarts after stability window
          ansible.builtin.command: "systemctl show {{ k3s_svc }} --property=NRestarts --value"
          register: k3s_final_nrestarts
          changed_when: false

        - name: Get journal if still failing or re-looping
          when: k3s_final_state.stdout != 'active' or k3s_final_nrestarts.stdout | int > 2
          ansible.builtin.command: "journalctl -u {{ k3s_svc }} --no-pager -n 30 -o short-iso"
          register: k3s_post_journal
          changed_when: false

        - name: Report post-restart state
          ansible.builtin.debug:
            msg: |
              {% if k3s_final_state.stdout == 'active' and k3s_final_nrestarts.stdout | int <= 2 %}
              FIXED: {{ k3s_svc }} is stable on {{ inventory_hostname }}
              ({{ k3s_final_nrestarts.stdout }} restarts in the 30s stability window)
              {% elif k3s_final_state.stdout == 'active' %}
              WARNING: {{ k3s_svc }} is active but restarting
              ({{ k3s_final_nrestarts.stdout }} restarts in 30s — still looping)

              Post-restart journal:
              {{ k3s_post_journal.stdout | default('(no output)') }}
              {% else %}
              !! {{ k3s_svc }} not active after restart — manual investigation required.

              Run on the node:
                journalctl -u {{ k3s_svc }} -f
                systemctl status {{ k3s_svc }}

              Post-restart journal:
              {{ k3s_post_journal.stdout | default('(no output)') }}
              {% endif %}
